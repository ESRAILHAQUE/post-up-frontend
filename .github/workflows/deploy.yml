name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Frontend to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_PAYPAL_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_PAYPAL_CLIENT_ID }}
        run: |
          echo "Checking Firebase environment variables..."
          if [ -z "$NEXT_PUBLIC_FIREBASE_API_KEY" ]; then
            echo "ERROR: NEXT_PUBLIC_FIREBASE_API_KEY is missing!"
            exit 1
          fi
          if [ -z "$NEXT_PUBLIC_FIREBASE_PROJECT_ID" ]; then
            echo "ERROR: NEXT_PUBLIC_FIREBASE_PROJECT_ID is missing!"
            exit 1
          fi
          echo "Firebase variables are set. Building..."
          npm run build

      - name: Deploy to VPS (with retry)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: ".next,public,package.json,package-lock.json,next.config.mjs,ecosystem.config.js"
          target: "/var/www/guestpostup/frontend"
          strip_components: 0
          rm: false
          timeout: 300s
          command_timeout: 15m
          use_insecure_cipher: false
        continue-on-error: true
        id: scp_deploy

      - name: Retry SCP if failed
        if: steps.scp_deploy.outcome == 'failure'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: ".next,public,package.json,package-lock.json,next.config.mjs,ecosystem.config.js"
          target: "/var/www/guestpostup/frontend"
          strip_components: 0
          rm: false
          timeout: 300s
          command_timeout: 15m
          use_insecure_cipher: false

      - name: Fallback: Deploy via SSH (if SCP fails)
        if: steps.scp_deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          timeout: 120s
          command_timeout: 15m
          script: |
            cd /var/www/guestpostup/frontend
            echo "ğŸ“¥ Pulling latest code via git..."
            git pull origin main || (git fetch origin main && git reset --hard origin/main)
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --legacy-peer-deps
            echo "ğŸ”¨ Building on VPS..."
            npm run build

      - name: SSH and restart frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          timeout: 120s
          command_timeout: 15m
          script: |
            cd /var/www/guestpostup/frontend
            
            # Check if package.json changed (only install if needed)
            if [ -f ".git/HEAD" ]; then
              git fetch origin main 2>/dev/null || true
              if git diff HEAD origin/main --name-only 2>/dev/null | grep -q "package.json\|package-lock.json"; then
                echo "ğŸ“¦ Package files changed, installing dependencies..."
                nice -n 10 npm ci --production --legacy-peer-deps
              else
                echo "â­ï¸  Skipping npm install (no package changes)"
              fi
            else
              # If git not available, check if node_modules exists
              if [ ! -d "node_modules" ]; then
                echo "ğŸ“¦ node_modules not found, installing dependencies..."
                nice -n 10 npm ci --production --legacy-peer-deps
              else
                echo "â­ï¸  Skipping npm install (node_modules exists)"
              fi
            fi
            
            # Zero-downtime restart using PM2 reload (graceful restart)
            if pm2 list | grep -q "guestpostup-frontend"; then
              echo "ğŸ”„ Gracefully reloading frontend (zero downtime)..."
              pm2 reload guestpostup-frontend --update-env || {
                echo "Reload failed, trying restart..."
                pm2 restart guestpostup-frontend --update-env || {
                  echo "Restart failed, starting fresh..."
                  pm2 delete guestpostup-frontend || true
                  pm2 start ecosystem.config.js
                }
              }
            else
              echo "ğŸš€ Starting new PM2 process..."
              pm2 start ecosystem.config.js
            fi
            
            pm2 save
            sleep 2
            echo "âœ… Deployment complete"
            pm2 show guestpostup-frontend | head -15
